---
title: "merge_sust_sfw"
author: "Gage Clawson"
date: "8/31/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup, message=FALSE, warning=FALSE}

getwd()
knitr::opts_chunk$set(eval=FALSE)
  
## Load libraries, set directories
library(ohicore)  #devtools::install_github('ohi-science/ohicore@dev')
library(dplyr)
library(stringr)
library(tidyr)
library(tidyverse)
library(taxize)

## Load FAO-specific user-defined functions
source('mar_fxs.R') # functions specific to mariculture dealing with compound countries
source('../../../workflow/R/fao_fxn.R') # function for cleaning FAO files
source('../../../workflow/R/common.R') # directory locations

```

# New Sustainability Scores from Seafood Watch Data

## Import data: Seafood Watch sustainability scores

These data describe the sustainability country/species combinations. In cases where these data were not available for a specific county/species, we averaged the data across taxonomic groups to gapfill the missing data.

```{r sw-scores}

## Load in Seafood Watch sustainability scores data from mazu:
sw_sus <- read.csv(file.path(dir_M, 'git-annex/globalprep/_raw_data/seafood_watch_mar_sustainability/d2020/Seafood-Watch_aquaculture-recs_July-2020.csv'), check.names = FALSE, stringsAsFactors = FALSE, na.strings = c("NA", ""))

head(sw_sus)

```

## Wrangle

### Tidy Seafood Watch sustainability data

Rename columns to match with MAR data and fill in species column

```{r tidy_sw-sus}

## Rename columns
sw_sus <- sw_sus %>%
  rename(report_title = 'Report Title',
         start_year = 'Start year',
         sw_species = 'Common name',
         genus = 'Genus',
         spp = 'Species',
         fao_species = 'FAO Common name',
         region = 'Region',
         country = 'Country',
         state_territory = 'State/Territory',
         sub_region = 'Sub-Region',
         water_body = 'Body of Water',
         parent_method = 'Parent Method',
         method = 'Method',
         score = 'Overall Score',
         rec = 'Overall Recommendation'
         ) %>% 
  dplyr::select(report_title, start_year, sw_species, genus, spp, fao_species, region, country, state_territory, sub_region, water_body, parent_method, method, score, rec)

## Change species names using FAO species name (fao_species); if NA, use common name (sw_species)
sw_sus$species <- ifelse(!is.na(sw_sus$fao_species), sw_sus$fao_species, sw_sus$sw_species)

```

### Keep NA countries

```{r keep-na-countries_sw-sus}

## These need to be re-added later (get cut when associated with region ids)
sw_sus_no_rgn <- filter(sw_sus, is.na(country))
  # 203 entries with no country

```

### Convert country names to OHI region IDs.

```{r sw-sus_convert-region}

## Change country names to match OHI region names
sw_sus <- sw_sus %>% 
  mutate(country = ifelse(country=="Korea, the Republic of", "South Korea", country)) %>% # Data removed for not having a match; change name to match
  mutate(country = ifelse(country=="United Kingdom of Great Britain and Northern Ireland (the)", "United Kingdom", country))  # Data removed for not having a match; change name to match

## Convert country names to OHI region IDs. (ohicore/R/name_2_rgn.R)
sw_sus_rgn <- name_2_rgn(df_in = sw_sus, 
                       fld_name='country', 
                       flds_unique=c('fao_species', 'sw_species', 'region', 'score'),
                       keep_fld_name = TRUE) # 'country' now shows the original Seafood Watch data name; 'rgn_name' is what we want to use from now on
  # Goes from 330 obs. to 127 obs. (because 203 obs. have no country associated)


## Re-add NA countries
sw_sus_rgn <- bind_rows(sw_sus_rgn, sw_sus_no_rgn) %>%
  unique()
  # Back to 330 obs.

```

**Check that the non-matches between Seafood Watch sustainability data species (sw_sus_rgn) and the FAO mariculture species in the wrangled FAO Aquaculture Production data table (maric) are not due to spelling errors or slightly different names. We want to include as many species that have sustainability scores as possible**

```{r sw-sus_check-non-matches}
maric <- read_csv("output/MAR_FP_data.csv")

## Make sure same species are spelled the same in the two data tables (e.g. check that there are no extra spaces)
sort(setdiff(sw_sus_rgn$species, maric$species)) # Seafood Watch species with no FAO data

sort(setdiff(maric$species, sw_sus_rgn$species)) # FAO species with no Seafood Watch data - there will probably be a long list

## Hand check each of the species output here. I mainly check to make sure there aren't obvious cases when the species is the same, but the names are presented slightly differently in the lists. For example, some species might have an extra space in the name somewhere. If any of these obvious differences exist, we need to go in and change the names to match. 
## Its not too surprising (unfortunately) that the FAO list has far more species than the sustainability list. But, I like to go over them to make sure that we are getting sustainability scores for as many species as we can.

```

```{r sw-sus_fix-non-matches}

## Rename species in Seafood Watch data to match FAO species data
sw_sus_rgn$species <- gsub("Abalone", "Abalones nei", sw_sus_rgn$species)
sw_sus_rgn$species <- gsub("Barramundi", "Barramundi(=Giant seaperch)", sw_sus_rgn$species)
sw_sus_rgn$species <- gsub("Coho salmon", "Coho(=Silver) salmon", sw_sus_rgn$species)
sw_sus_rgn$species <- gsub("Manila clam", "Japanese carpet shell", sw_sus_rgn$species) # Japanese carpet shell is another name for Manila clam (thanks animal crossing :P )
sw_sus_rgn$species <- gsub("New Zealand Mussel", "New Zealand mussel", sw_sus_rgn$species)
sw_sus_rgn$species <- gsub("Hard clam (unspecified)", "Northern quahog(=Hard clam)", sw_sus_rgn$species) # Hard clams are also known as quahogs, round clams, or hard-shell clams

```

# FAO mariculture and Seafood Watch sustainability scores

```{r match-type_sw-sus-data}

## Add column "match_type" to categorize obs. that 1) have a country associated, 2) are "global" Seafood Watch data, or 3) only distinguished by water body
sw_sus_rgn <- sw_sus_rgn %>% 
  dplyr::mutate(match_type = dplyr::case_when(!is.na(country) ~ "sw_sp_c", # Add match type specific to species/country
                                str_detect(report_title, regex("Global")) ~ "sw_sp_g", # Add match type specific to species/global Seafood Watch data
                                TRUE ~ "sw_sp_w" # Add match type specific to species/water body
  ))

table(sw_sus_rgn$match_type)

```

```{r gapfill-sw-sus-match-rgn-id}

## Add column "gapfill" to track which match_type uses the Seafood Watch sustainability data directly, or needs to be gapfilled
sw_sus_rgn <- sw_sus_rgn %>% 
  dplyr::mutate(gapfill = dplyr::case_when(match_type == "sw_sp_c" ~ "actuals",
                                           match_type == "sw_sp_g" ~ "sp_global",
                                           match_type == "sw_sp_w" ~ "sp_waterbody"))

```

```{r gf_sw_sp_w}
  

## Add a line for each country that borders each water body
  # The only water body is the Mediterranean; add all countries that border it (source: https://www.medqsr.org/mediterranean-marine-and-coastal-environment#:~:text=Today%2021%20countries%2C%20with%20surface,Syria%2C%20Tunisia%2C%20and%20Turkey.)
gf_sw_sp_w <- sw_sus_rgn %>% 
  filter(match_type == 'sw_sp_w') %>% 
  # Atlantic bluefin tuna - Marine net pen
  add_row(rgn_id = 82, rgn_name = 'Albania', species = 'Atlantic bluefin tuna', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 1) %>% 
  add_row(rgn_id = 84, rgn_name = 'Algeria', species = 'Atlantic bluefin tuna', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 1) %>%
  add_row(rgn_id = 232, rgn_name = 'Bosnia and Herzegovina', species = 'Atlantic bluefin tuna', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 1) %>%
  add_row(rgn_id = 187, rgn_name = 'Croatia', species = 'Atlantic bluefin tuna', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 1) %>%
  add_row(rgn_id = 81, rgn_name = 'Cyprus', species = 'Atlantic bluefin tuna', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 1) %>%
  add_row(rgn_id = 214, rgn_name = 'Egypt', species = 'Atlantic bluefin tuna', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 1) %>%
  add_row(rgn_id = 179, rgn_name = 'France', species = 'Atlantic bluefin tuna', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 1) %>%
  add_row(rgn_id = 80, rgn_name = 'Greece', species = 'Atlantic bluefin tuna', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 1) %>%
  add_row(rgn_id = 79, rgn_name = 'Israel', species = 'Atlantic bluefin tuna', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 1) %>%
  add_row(rgn_id = 184, rgn_name = 'Italy', species = 'Atlantic bluefin tuna', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 1) %>%
  add_row(rgn_id = 78, rgn_name = 'Lebanon', species = 'Atlantic bluefin tuna', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 1) %>%
  add_row(rgn_id = 67, rgn_name = 'Libya', species = 'Atlantic bluefin tuna', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 1) %>%
  add_row(rgn_id = 68, rgn_name = 'Malta', species = 'Atlantic bluefin tuna', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 1) %>%
  add_row(rgn_id = 185, rgn_name = 'Monaco', species = 'Atlantic bluefin tuna', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 1) %>%
  add_row(rgn_id = 186, rgn_name = 'Montenegro', species = 'Atlantic bluefin tuna', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 1) %>%
  add_row(rgn_id = 62, rgn_name = 'Morocco', species = 'Atlantic bluefin tuna', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 1) %>%
  add_row(rgn_id = 188, rgn_name = 'Slovenia', species = 'Atlantic bluefin tuna', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 1) %>%
  add_row(rgn_id = 182, rgn_name = 'Spain', species = 'Atlantic bluefin tuna', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 1) %>%
  add_row(rgn_id = 77, rgn_name = 'Syria', species = 'Atlantic bluefin tuna', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 1) %>%
  add_row(rgn_id = 61, rgn_name = 'Tunisia', species = 'Atlantic bluefin tuna', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 1) %>%
  add_row(rgn_id = 76, rgn_name = 'Turkey', species = 'Atlantic bluefin tuna', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 1) %>% 

  # Gilthead seabream - Marine net pen
  add_row(rgn_id = 82, rgn_name = 'Albania', species = 'Gilthead seabream', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 23) %>% 
  add_row(rgn_id = 84, rgn_name = 'Algeria', species = 'Gilthead seabream', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 23) %>%
  add_row(rgn_id = 232, rgn_name = 'Bosnia and Herzegovina', species = 'Gilthead seabream', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 23) %>%
  add_row(rgn_id = 187, rgn_name = 'Croatia', species = 'Gilthead seabream', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 23) %>%
  add_row(rgn_id = 81, rgn_name = 'Cyprus', species = 'Gilthead seabream', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 23) %>%
  add_row(rgn_id = 214, rgn_name = 'Egypt', species = 'Gilthead seabream', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 23) %>%
  add_row(rgn_id = 179, rgn_name = 'France', species = 'Gilthead seabream', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 23) %>%
  add_row(rgn_id = 80, rgn_name = 'Greece', species = 'Gilthead seabream', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 23) %>%
  add_row(rgn_id = 79, rgn_name = 'Israel', species = 'Gilthead seabream', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 23) %>%
  add_row(rgn_id = 184, rgn_name = 'Italy', species = 'Gilthead seabream', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 23) %>%
  add_row(rgn_id = 78, rgn_name = 'Lebanon', species = 'Gilthead seabream', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 23) %>%
  add_row(rgn_id = 67, rgn_name = 'Libya', species = 'Gilthead seabream', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 23) %>%
  add_row(rgn_id = 68, rgn_name = 'Malta', species = 'Gilthead seabream', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 23) %>%
  add_row(rgn_id = 185, rgn_name = 'Monaco', species = 'Gilthead seabream', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 23) %>%
  add_row(rgn_id = 186, rgn_name = 'Montenegro', species = 'Gilthead seabream', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 23) %>%
  add_row(rgn_id = 62, rgn_name = 'Morocco', species = 'Gilthead seabream', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 23) %>%
  add_row(rgn_id = 188, rgn_name = 'Slovenia', species = 'Gilthead seabream', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 23) %>%
  add_row(rgn_id = 182, rgn_name = 'Spain', species = 'Gilthead seabream', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 23) %>%
  add_row(rgn_id = 77, rgn_name = 'Syria', species = 'Gilthead seabream', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 23) %>%
  add_row(rgn_id = 61, rgn_name = 'Tunisia', species = 'Gilthead seabream', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 23) %>%
  add_row(rgn_id = 76, rgn_name = 'Turkey', species = 'Gilthead seabream', score = 4.42, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 23) %>% 
  
  # Meagre - Marine net pen
  add_row(rgn_id = 82, rgn_name = 'Albania', species = 'Meagre', score = 4.29, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 45) %>% 
  add_row(rgn_id = 84, rgn_name = 'Algeria', species = 'Meagre', score = 4.29, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 45) %>%
  add_row(rgn_id = 232, rgn_name = 'Bosnia and Herzegovina', species = 'Meagre', score = 4.29, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 45) %>%
  add_row(rgn_id = 187, rgn_name = 'Croatia', species = 'Meagre', score = 4.29, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 45) %>%
  add_row(rgn_id = 81, rgn_name = 'Cyprus', species = 'Meagre', score = 4.29, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 45) %>%
  add_row(rgn_id = 214, rgn_name = 'Egypt', species = 'Meagre', score = 4.29, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 45) %>%
  add_row(rgn_id = 179, rgn_name = 'France', species = 'Meagre', score = 4.29, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 45) %>%
  add_row(rgn_id = 80, rgn_name = 'Greece', species = 'Meagre', score = 4.29, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 45) %>%
  add_row(rgn_id = 79, rgn_name = 'Israel', species = 'Meagre', score = 4.29, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 45) %>%
  add_row(rgn_id = 184, rgn_name = 'Italy', species = 'Meagre', score = 4.29, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 45) %>%
  add_row(rgn_id = 78, rgn_name = 'Lebanon', species = 'Meagre', score = 4.29, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 45) %>%
  add_row(rgn_id = 67, rgn_name = 'Libya', species = 'Meagre', score = 4.29, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 45) %>%
  add_row(rgn_id = 68, rgn_name = 'Malta', species = 'Meagre', score = 4.29, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 45) %>%
  add_row(rgn_id = 185, rgn_name = 'Monaco', species = 'Meagre', score = 4.29, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 45) %>%
  add_row(rgn_id = 186, rgn_name = 'Montenegro', species = 'Meagre', score = 4.29, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 45) %>%
  add_row(rgn_id = 62, rgn_name = 'Morocco', species = 'Meagre', score = 4.29, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 45) %>%
  add_row(rgn_id = 188, rgn_name = 'Slovenia', species = 'Meagre', score = 4.29, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 45) %>%
  add_row(rgn_id = 182, rgn_name = 'Spain', species = 'Meagre', score = 4.29, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 45) %>%
  add_row(rgn_id = 77, rgn_name = 'Syria', species = 'Meagre', score = 4.29, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 45) %>%
  add_row(rgn_id = 61, rgn_name = 'Tunisia', species = 'Meagre', score = 4.29, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 45) %>%
  add_row(rgn_id = 76, rgn_name = 'Turkey', species = 'Meagre', score = 4.29, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 45) %>% 
  
# European seabass - Marine net pen
  add_row(rgn_id = 82, rgn_name = 'Albania', species = 'European seabass', score = 4.45, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 67) %>% 
  add_row(rgn_id = 84, rgn_name = 'Algeria', species = 'European seabass', score = 4.45, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 67) %>%
  add_row(rgn_id = 232, rgn_name = 'Bosnia and Herzegovina', species = 'European seabass', score = 4.45, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 67) %>%
  add_row(rgn_id = 187, rgn_name = 'Croatia', species = 'European seabass', score = 4.45, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 67) %>%
  add_row(rgn_id = 81, rgn_name = 'Cyprus', species = 'European seabass', score = 4.45, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 67) %>%
  add_row(rgn_id = 214, rgn_name = 'Egypt', species = 'European seabass', score = 4.45, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 67) %>%
  add_row(rgn_id = 179, rgn_name = 'France', species = 'European seabass', score = 4.45, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 67) %>%
  add_row(rgn_id = 80, rgn_name = 'Greece', species = 'European seabass', score = 4.45, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 67) %>%
  add_row(rgn_id = 79, rgn_name = 'Israel', species = 'European seabass', score = 4.45, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 67) %>%
  add_row(rgn_id = 184, rgn_name = 'Italy', species = 'European seabass', score = 4.45, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 67) %>%
  add_row(rgn_id = 78, rgn_name = 'Lebanon', species = 'European seabass', score = 4.45, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 67) %>%
  add_row(rgn_id = 67, rgn_name = 'Libya', species = 'European seabass', score = 4.45, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 67) %>%
  add_row(rgn_id = 68, rgn_name = 'Malta', species = 'European seabass', score = 4.45, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 67) %>%
  add_row(rgn_id = 185, rgn_name = 'Monaco', species = 'European seabass', score = 4.45, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 67) %>%
  add_row(rgn_id = 186, rgn_name = 'Montenegro', species = 'European seabass', score = 4.45, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 67) %>%
  add_row(rgn_id = 62, rgn_name = 'Morocco', species = 'European seabass', score = 4.45, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 67) %>%
  add_row(rgn_id = 188, rgn_name = 'Slovenia', species = 'European seabass', score = 4.45, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 67) %>%
  add_row(rgn_id = 182, rgn_name = 'Spain', species = 'European seabass', score = 4.45, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 67) %>%
  add_row(rgn_id = 77, rgn_name = 'Syria', species = 'European seabass', score = 4.45, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 67) %>%
  add_row(rgn_id = 61, rgn_name = 'Tunisia', species = 'European seabass', score = 4.45, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 67) %>%
  add_row(rgn_id = 76, rgn_name = 'Turkey', species = 'European seabass', score = 4.45, match_type = 'sw_sp_w', gapfill = 'sp_waterbody', .after = 67)

```


```{r}
## Join data specific to species/country
sw_sp_c <- sw_sus_rgn %>%
  filter(match_type == 'sw_sp_c') %>%
  select(rgn_id, species, Sust_sw_sp_c = score)

mar_sw_sus <- maric %>%
  left_join(sw_sp_c, by = c("species", "rgn_id"))

## Join data specific to species/water body
sw_sp_w <- gf_sw_sp_w %>%
  select(rgn_id, species, Sust_sw_sp_w = score)

mar_sw_sus <- mar_sw_sus %>%
  left_join(sw_sp_w, by= c("species", "rgn_id"))


## Join data specific to species/global Seafood Watch data
sw_sp_g <- sw_sus_rgn %>% 
  filter(match_type == 'sw_sp_g') %>%
  select(species, Sust_sw_sp_g = score)

mar_sw_sus <- mar_sw_sus %>%
  left_join(sw_sp_g, by= c("species"))
```


Since some regions have multiple sustainability scores for the same species due to multiple aquaculture methods, but we don't know what proportions of which methods are used, we take the average of the sustainability scores in these instances.

Merge the three Seafood Watch type categories into a single sustainability score column in the following order:


1. Sust_sw_sp_c: specific to species/country
2. Sust_sw_sp_w: specific to species/water body
3. Sust_sw_sp_g: specific to species/global Seafood Watch data

For example, if Sust_mean is missing, use Sust_sw_sp_c and so on. 

```{r}
mar_sw_sus = mar_sw_sus %>% 
  dplyr::mutate(Sust = ifelse(!is.na(Sust_sw_sp_c), Sust_sw_sp_c, Sust_sw_sp_w)) %>%
  dplyr::mutate(Sust = ifelse(is.na(Sust), Sust_sw_sp_g, Sust)) %>%
  dplyr::mutate(sust_coeff = case_when(Sust_sw_sp_c == Sust ~ "none",
                                        is.na(Sust_sw_sp_c) & Sust_sw_sp_w == Sust ~ "water_body",
                                        is.na(Sust_sw_sp_c) & is.na(Sust_sw_sp_w) & Sust_sw_sp_g == Sust ~ "global")) %>%
  dplyr::select(-Sust_sw_sp_c, -Sust_sw_sp_w, -Sust_sw_sp_g)

summary(mar_sw_sus)
```

Average sustainability scores within regions with more than score (due to more than one aquaculture method):

```{r sw-sus-avg}

mar_sw_sus <- mar_sw_sus %>% 
  dplyr::group_by(rgn_id, species) %>% 
  dplyr::mutate(Sust_avg = mean(Sust, na.rm=TRUE)) %>% 
  dplyr::ungroup()

```

Get rid of duplicates for region/species/year:

```{r sw-sus-dup}

mar_sw_sus <- mar_sw_sus %>% 
  dplyr::distinct(rgn_id, species, environment, year, .keep_all = TRUE) %>%
  dplyr::select(-Sust, Sust = Sust_avg)


```

**Now look at a summary after appending all the Seafood Watch data**

```{r sw-sus-summary}

summary(mar_sw_sus)
# Sust_avg still has 17123 NAs out of 28507 total obs.; ~60% without sustainability data

```

**LAURA STOPPED HERE 8.28.2020**
- need to gapfill by averaging species within a taxonomic category


This joins the sustainability data that is gapfilled either at the species level (average of specific species/genera across regions) or at a higher course taxonomic levels and documents which data are gapfilled and how.


```{r}
mar_sw_sus_test <- mar_sw_sus %>%
  group_by(species) %>%
  mutate(avg_sp_sust = mean(Sust, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(Taxon_code) %>%
  mutate(avg_tx_sust = mean(Sust, na.rm = TRUE)) %>%
  ungroup()
```


**Take a look at the wrangled data**

```{r view-sw-sus-gapfilled}

# summary(mar_sw_sus_gf)
# 
# table(mar_sw_sus_gf$gapfill)

```

Obtain a sustainability score for each record, and a book-keeping column of whether it's actual or gapfilled

For missing sustainability scores:

1. Use species-level Sustainability score
2. If no species-level scores, gapfill with genus-level sustainability average

```{r sw-sus-gapfill-missing}

# mar_sw_sus_final = mar_sw_sus_gf %>% 
#   mutate(gapfill = ifelse(!is.na(Sust), "none", gapfill)) %>%
#   mutate(Sust = ifelse(is.na(Sust), Sust_gf_sp, Sust)) %>% # Gapfill with species level
#   mutate(gapfill = ifelse(is.na(Sust), "taxon_average", gapfill)) %>% # Add in taxon gapfill record
#   mutate(Sust = ifelse(is.na(Sust), Sust_gf_taxon, Sust)) %>% # Gapfill with taxon level
#   mutate(taxa_code = paste(species, species_code, sep="_")) %>%
#   select(rgn_id, species, species_code, taxa_code, taxa_group=Taxon_code, year, gapfill_sus = gapfill, gapfill_fao = gap_0_fill, tonnes=value, Sust)

```

# Save Data:

```{r save-mar-sw-harvest-data}

# ## Save mariculture harvest data
# mar_harvest_tonnes = mar_sus_final %>%
#   select(rgn_id, taxa_code, taxa_group, year, tonnes)
# 
# anyDuplicated(mar_harvest_tonnes) # Check for duplication
# 
# ## Saves the appropriate Mariculture Harvest Tonnes file depending on whether we are excluding species based on best judgment (exclude), all seaweeds (exclude_no_seaweed), or just seaweeds nei (exclude_no_nei). See method changes above.
# if(sum(str_detect(names(mar_sp), "exclude$"))==1) {
#  write.csv(mar_harvest_tonnes, 'output/mar_harvest_tonnes.csv', row.names=F)
#  } else if (sum(str_detect(names(mar_sp), "exclude_no_seaweed"))==1) {
#    write.csv(mar_harvest_tonnes, 'test/mar_harvest_tonnes_no_seaweed.csv', row.names=F)
#    } else if (sum(str_detect(names(mar_sp), "exclude_no_nei"))==1) {
#      write.csv(mar_harvest_tonnes, 'test/mar_harvest_tonnes_no_nei.csv', row.names=F)
#      }
# 
# ## Save gapfill data for mariculture harvest
# mar_harvest_tonnes_gf = mar_sus_final %>%
#   select(rgn_id, taxa_code, taxa_group, year, tonnes=gapfill_fao)
# 
# 
# ## Saves the appropriate Mariculture Harvest Gapfill file depending on whether we are excluding species based on best judgment (exclude), all seaweeds (exclude_no_seaweed), or just seaweeds nei (exclude_no_nei). See method changes above
# if(sum(str_detect(names(mar_sp), "exclude$"))==1) {
#  write.csv(mar_harvest_tonnes_gf, 'output/mar_harvest_tonnes_gf.csv', row.names=F)
#  } else if (sum(str_detect(names(mar_sp), "exclude_no_seaweed"))==1) {
#    write.csv(mar_harvest_tonnes_gf, 'test/mar_harvest_tonnes_gf_no_seaweed.csv', row.names=F)
#    } else if (sum(str_detect(names(mar_sp), "exclude_no_nei"))==1) {
#      write.csv(mar_harvest_tonnes_gf, 'test/mar_harvest_tonnes_gf_no_nei.csv', row.names=F)
#      }
# 
# 
# ## Save sustainability scores data for 2012
# mar_sustainability_score = mar_sus_final %>% 
#   mutate(year = 2012) %>% # Only 2012 sustainability scores exist (Trujillo)
#   select(rgn_id, year, taxa_code, sust_coeff = Sust) %>% 
#   unique()
# 
# anyDuplicated(mar_sustainability_score)
# 
# 
# ## Saves the appropriate Sustainability Score file depending on whether we are excluding species based on best judgment (exclude), all seaweeds (exclude_no_seaweed), or just seaweeds nei (exclude_no_nei). See method changes above
# if(sum(str_detect(names(mar_sp), "exclude$"))==1) {
#  write.csv(mar_sustainability_score, 'output/mar_sustainability.csv', row.names=F)
#  } else if (sum(str_detect(names(mar_sp), "exclude_no_seaweed"))==1) {
#    write.csv(mar_sustainability_score, 'test/mar_sustainability_no_seaweed.csv', row.names=F)
#    } else if (sum(str_detect(names(mar_sp), "exclude_no_nei"))==1) {
#      write.csv(mar_sustainability_score, 'test/mar_sustainability_no_nei.csv', row.names=F)
#      }
# 
# 
# ## Save gapfill data for sustainability scores
# mar_sustainability_score_gf = mar_sus_final %>% 
#   select(rgn_id, taxa_code, sust_coeff = gapfill_sus) %>% 
#   unique()
# 
# 
# ## Saves the appropriate Sustainability Score Gapfill file depending on whether we are excluding species based on best judgment (exclude), all seaweeds (exclude_no_seaweed), or just seaweeds nei (exclude_no_nei). See method changes above
# if(sum(str_detect(names(mar_sp), "exclude$"))==1) {
#  write.csv(mar_sustainability_score_gf, 'output/mar_sustainability_gf.csv', row.names=F)
#  } else if (sum(str_detect(names(mar_sp), "exclude_no_seaweed"))==1) {
#    write.csv(mar_sustainability_score_gf, 'test/mar_sustainability_gf_no_seaweed.csv', row.names=F)
#    } else if (sum(str_detect(names(mar_sp), "exclude_no_nei"))==1) {
#      write.csv(mar_sustainability_score_gf, 'test/mar_sustainability_gf_no_nei.csv', row.names=F)
#      }

```